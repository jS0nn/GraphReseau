<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Éditeur Réseau — Embed</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=">
    <link rel="stylesheet" href="/static/vendor/inter/index.css">
    <link rel="stylesheet" href="/static/vendor/unicons/css/line.css">
    <link rel="stylesheet" href="/static/vendor/leaflet/leaflet.css">
    <link rel="stylesheet" href="/static/bundle/editor.css">
    <link rel="stylesheet" href="/static/bundle/app.css">
  </head>
  <body data-theme="dark" class="prop-collapsed"
        data-tiles-url="{{ (tiles_url or '') }}"
        data-tiles-attribution="{{ (tiles_attribution or '') }}"
        data-tiles-api-key="{{ (tiles_api_key or '') }}">
    <!-- Barre d’outils -->
    <header class="appbar" id="appbar">
      <div class="title">Éditeur réseau</div>
      <button class="btn" id="loadBtn"><i class="uil uil-import"></i>Charger</button>
      <button class="btn primary" id="saveBtn" title="Ctrl/Cmd+S"><i class="uil uil-save"></i>Sauvegarder</button>
      <button class="btn" id="layoutBtn" title="L"><i class="uil uil-horizontal-align-right"></i>Agencer</button>
      <div class="seg" id="modes">
        <button id="modeSelect" class="active" title="Sélection (V)" aria-keyshortcuts="v"><i class="uil uil-mouse"></i> Sélection</button>
        <button id="modeDraw" title="Dessiner (D)" aria-keyshortcuts="d"><i class="uil uil-pen"></i> Dessiner</button>
        <button id="modeEdit" title="Éditer (E)" aria-keyshortcuts="e"><i class="uil uil-edit"></i> Éditer</button>
        <button id="modeJunction" title="Insérer (I) — clic sur une canalisation" aria-keyshortcuts="i"><i class="uil uil-focus-add"></i> Insérer</button>
        <button id="modeDelete" title="Supprimer (Suppr)" aria-keyshortcuts="Delete"><i class="uil uil-trash-alt"></i> Supprimer</button>
      </div>
      <div class="menu-add">
        <button class="btn" id="addBtn"><i class="uil uil-plus"></i> Ajouter</button>
        <div class="menu" id="addMenu">
          <div class="item" data-add="OUVRAGE"><i class="uil uil-water"></i> Ouvrage</div>
          <!-- Canal nodes disabled: pipelines are modeled as edges -->
          <div class="item" data-add="GENERAL"><i class="uil uil-constructor"></i> Général</div>
          <div class="item" data-add="VANNE"><i class="uil uil-sliders-v"></i> Vanne</div>
          <div class="item" data-add="POINT_MESURE"><i class="uil uil-analytics"></i> Point de mesure</div>
        </div>
      </div>
      <div class="seg" title="Zoom (Espace = pan)">
        <button id="zoomOutBtn" class="ghost"><i class="uil uil-minus-circle"></i></button>
        <button id="zoomInBtn"  class="ghost"><i class="uil uil-plus-circle"></i></button>
        <button id="zoomFitBtn" class="ghost" title="Adapter"><i class="uil uil-expand-alt"></i></button>
      </div>
      <button class="btn" id="mapToggleBtn" title="Fond orthophoto"><i class="uil uil-image"></i> Fond</button>
      <div class="plan-controls" id="planControls" hidden>
        <button class="btn" id="planToggleBtn" type="button" title="Afficher/Masquer le plan"><i class="uil uil-layer-group"></i> Plan</button>
        <div class="plan-tools" id="planTools">
          <label class="plan-field" id="planOpacityGroup" title="Opacité du plan">
            <span>Opacité</span>
            <input id="planOpacityRange" type="range" min="0" max="100" step="1" value="70" aria-label="Opacité du plan (pourcentage)">
            <span class="plan-value" id="planOpacityValue">70%</span>
          </label>
        <div class="plan-field plan-rotation" id="planRotationGroup" title="Rotation du plan">
          <button class="btn ghost" id="planRotateLeftBtn" type="button" aria-label="Tourner le plan vers la gauche">
            <i class="uil uil-undo"></i>
          </button>
          <input id="planRotationRange" type="range" min="-180" max="180" step="1" value="0" aria-label="Rotation du plan (degrés)">
          <span class="plan-value" id="planRotationValue">0°</span>
          <button class="btn ghost" id="planRotateRightBtn" type="button" aria-label="Tourner le plan vers la droite">
            <i class="uil uil-redo"></i>
          </button>
          <button class="btn ghost" id="planRotateResetBtn" type="button" aria-label="Réinitialiser l’orientation du plan">
            <i class="uil uil-compass"></i>
          </button>
        </div>
        <button class="btn ghost" id="planWhiteToggleBtn" type="button" title="Afficher/Masquer le fond blanc">
          <i class="uil uil-square"></i> Fond blanc
        </button>
      </div>
      <div class="plan-status" id="planStatus" aria-live="polite"></div>
    </div>
      <button class="btn" id="thicknessBtn" title="Épaisseur des arêtes (Ø)"><i class="uil uil-line-alt"></i> Épaisseur</button>
      <button class="btn" id="exportBtn"><i class="uil uil-export"></i> Export JSON</button>
      <div class="spacer"></div>
      <button class="btn" id="logBtn" title="Afficher/Masquer logs"><i class="uil uil-file-alt"></i> Logs</button>
      <button class="btn" id="themeBtn" title="Thème"><i class="uil uil-brightness-half"></i> Thème</button>
      <button class="btn" id="helpBtn"><i class="uil uil-question-circle"></i> Aide</button>
    </header>

    <!-- Canvas + Propriétés -->
    <div id="wrap">
      <div id="canvas">
        <div id="map" aria-hidden="true"></div>
        <svg id="svg">
          <defs>
            <marker id="arrow" viewBox="0 -5 10 10" refX="7.2" refY="0" markerWidth="6" markerHeight="6" orient="auto">
              <path d="M0,-5L10,0L0,5"></path>
            </marker>
            <marker id="arrowSel" viewBox="0 -5 10 10" refX="7.2" refY="0" markerWidth="6" markerHeight="6" orient="auto">
              <path d="M0,-5L10,0L0,5"></path>
            </marker>
          </defs>
          <g id="zoomRoot">
            <g class="inline-conns"></g>
            <g class="edges"></g>
            <g class="nodes"></g>
            <g class="overlay"></g>
          </g>
        </svg>
      </div>

      <aside id="prop">
        <div class="card">
          <h3 style="margin:4px 0 8px">Propriétés</h3>
          <div id="noSel">Aucune sélection.</div>
          <form id="nodeForm" style="display:none">
            <details id="grpGeneral" open>
              <summary>Général</summary>
              <label>ID
                <input id="nodeId" readonly placeholder="auto-généré">
              </label>
              <label>Nom <input name="name" placeholder="ex. P-012"></label>
              <label>Type
                <select name="type">
                  <option>OUVRAGE</option>
                  <option>GENERAL</option>
                  <option>VANNE</option>
                  <option>POINT_MESURE</option>
                </select>
              </label>
              <div id="grpCanalProps" style="display:none">
                <label>Diamètre extérieur (mm) <input name="diameter_mm" type="number" min="0"></label>
                  <label>Matériau <input name="material" placeholder="ex. PVC"></label>
              </div>
              <div id="grpPipeInfo" style="display:none">
                <label>Canalisation
                  <input id="pipeInfoName" readonly placeholder="— non raccordé —">
                </label>
                <label>Diamètre (mm)
                  <input id="pipeInfoDiameter" readonly>
                </label>
                <label>Matériau
                  <input id="pipeInfoMaterial" readonly>
                </label>
              </div>
              <label>Commentaire
                <textarea name="commentaire" rows="2" placeholder="Notes libres"></textarea>
              </label>
            </details>
            <details id="grpGeneralMgmt" open style="display:none">
              <summary>Élément général — Actions</summary>
              <div style="display:grid; grid-template-columns:1fr; gap:6px; margin-bottom:6px">
                <div style="color:var(--muted)">Canalisations non raccordées <span id="genUnassignedCanalsCount"></span></div>
                <input id="genCanalSearch" placeholder="Rechercher… (ex. cana)" aria-label="Recherche canalisations" />
                <div class="chips" id="genUnassignedCanals" style="max-height: 180px; overflow:auto; min-height:36px"></div>
              </div>
              <div style="display:flex; justify-content:flex-end">
                <button type="button" class="btn" id="genAddCanalBtn">Nouvelle canalisation</button>
              </div>
            </details>
            <details id="grpWell" open style="display:none">
              <summary>Ouvrage — Affectation</summary>
              <label>Canalisation</label>
              <select id="wellCanalSelect"></select>
              <label>Position (info)
                <input id="wellPosInfo" readonly placeholder="— défini dans la canalisation —">
              </label>
            </details>
            <details id="grpCanal" open style="display:none">
              <summary>Canalisation</summary>
              <details id="grpSeq">
                <summary>Ordre (amont → aval)</summary>
                <div class="chips" id="seqList" aria-label="séquence puits/mesures/vannes"></div>
                <small style="color:var(--muted); display:block; margin-top:8px">
                  Ouvrage ↔ arête <b>Canalisation → Ouvrage</b>. Les PM & Vannes s’insèrent entre les ouvrages.
                </small>
              </details>
              <details id="grpUnassigned">
                <summary>Ajouter</summary>
                <div style="display:grid; grid-template-columns:1fr; gap:6px; margin-top:6px">
                  <div style="color:var(--muted)">Ouvrages <span id="unassignedWellsCount"></span></div>
                  <input id="cwSearch" placeholder="Rechercher… (ex. p1)" aria-label="Recherche ouvrages" />
                  <div class="chips" id="unassignedWells" style="max-height: 180px; overflow:auto; min-height:36px"></div>
                  <div style="display:flex; justify-content:flex-end"><button type="button" class="btn" id="cwAddNewBtn">Nouvel ouvrage</button></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr; gap:6px; margin-top:6px">
                  <div style="color:var(--muted)">Points de mesure <span id="unassignedPMsCount"></span></div>
                  <input id="pmSearch" placeholder="Rechercher… (ex. p1)" aria-label="Recherche points de mesure" />
                  <div class="chips" id="unassignedPMs" style="max-height: 180px; overflow:auto; min-height:36px"></div>
                  <div style="display:flex; justify-content:flex-end"><button type="button" class="btn" id="pmAddNewBtn">Nouveau PM</button></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr; gap:6px; margin-top:6px">
                  <div style="color:var(--muted)">Vannes <span id="unassignedVannesCount"></span></div>
                  <input id="vanSearch" placeholder="Rechercher… (ex. v1)" aria-label="Recherche vannes" />
                  <div class="chips" id="unassignedVannes" style="max-height: 180px; overflow:auto; min-height:36px"></div>
                  <div style="display:flex; justify-content:flex-end"><button type="button" class="btn" id="vanAddNewBtn">Nouvelle vanne</button></div>
                </div>
              </details>
              <details id="grpBranches">
                <summary>Branchements</summary>
                <div class="chips" id="childCanalsList"></div>
                <small style="color:var(--muted)">Connecte d’abord les canalisations au parent, puis ordonne les puces selon l’ordre le long du parent.</small>
              </details>
              <div id="canalBadges" class="badges"></div>
            </details>
            <details id="grpInline" open style="display:none">
              <summary>PM / Vanne — Affectation</summary>
              <label>Canalisation (arête)</label>
              <select id="inlEdgeSelect"></select>
              <label>Position (info)
                <input id="inlPosInfo" readonly placeholder="— défini dans la canalisation —">
              </label>
              <label>Offset sur l’arête (m, optionnel)
                <input id="inlOffsetInput" type="number" step="0.1" placeholder="ex. 12.5">
              </label>
            </details>
            <details id="grpPos" open>
              <summary>Position & GPS</summary>
              <label style="display:flex; align-items:center; gap:8px">
                <input id="gpsLockToggle" type="checkbox"> Ancrer au GPS (verrouiller)
              </label>
              <label>X <input name="x_UI" type="number" step="1"></label>
              <label>Y <input name="y_UI" type="number" step="1"></label>
              <label>Latitude <input name="gps_lat" type="number" step="0.000001"></label>
              <label>Longitude <input name="gps_lon" type="number" step="0.000001"></label>
            </details>
            <button type="button" id="deleteNodeBtn" class="btn danger" style="width:100%; margin-top:10px"><i class="uil uil-trash-alt"></i> Supprimer ce nœud</button>
          </form>
          <form id="edgeForm" style="display:none; margin-top:8px">
            <!-- First row: ID (full width) -->
            <div style="display:grid; grid-template-columns:1fr; gap:8px; margin-bottom:6px">
              <div><label>ID<input id="edgeId" readonly></label></div>
            </div>
            <!-- Second row: From/To (two columns) -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
              <div><label>De (amont)<input name="from_name" readonly></label></div>
              <div><label>Vers (aval)<input name="to_name" readonly></label></div>
            </div>
            <label>Branche (identifiant)
              <input id="edgeBranchId" name="branch_id" placeholder="Identifiant de branche" readonly>
            </label>
            <label>Branche (nom)
              <input id="edgeBranchName" name="branch_name" placeholder="Nom de branche">
            </label>
            <button type="button" id="flipEdgeBtn" class="btn" style="width:100%"><i class="uil uil-exchange"></i> Inverser le sens</button>
            <label>Diamètre (mm)
              <input name="diameter_mm" type="number" min="0" step="0.1" placeholder="ex. 160">
            </label>
            <label>SDR
              <input name="sdr" placeholder="ex. SDR11">
            </label>
            <label>Matériau
              <input name="material" placeholder="ex. PEHD">
            </label>
            <label>Actif
              <select name="active">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </label>
            <label>Commentaire
              <textarea name="commentaire" rows="2" placeholder="Notes libres"></textarea>
            </label>
            <button type="button" id="deleteEdgeBtn" class="btn danger" style="width:100%; margin-top:8px"><i class="uil uil-trash-alt"></i> Supprimer</button>
          </form>
        </div>
      </aside>
    </div>

    <!-- Logs -->
    <div id="logDrawer">
      <div id="logHeader">
        <strong>Journal des actions</strong>
        <div class="spacer"></div>
        <button class="btn" id="logClear"><i class="uil uil-trash-alt"></i> Vider</button>
        <button class="btn" id="logDownload"><i class="uil uil-download-alt"></i> Exporter</button>
        <button class="btn" id="logClose"><i class="uil uil-angle-down"></i> Fermer</button>
      </div>
      <div id="logBody"></div>
    </div>

    <!-- Aide -->
    <dialog id="helpDlg">
      <article>
        <header><strong>Aide rapide</strong></header>
        <ul>
          <li><b>Agencer</b> : mise en page automatique (ELK, avec repli fallback+).</li>
          
          <li><b>Dessiner (D)</b> :
            <ul>
              <li>Clic = ajouter un sommet; <b>Double‑clic/Entrée</b> = terminer; <b>Échap</b> = annuler.</li>
              <li>Clic sur un <b>nœud</b> = démarre/s’attache au nœud (pas de doublon).</li>
              <li>Clic sur une <b>canalisation</b> = split au point cliqué, crée une jonction, et s’y attache.</li>
            </ul>
          </li>
          <li><b>Sélection (V)</b> :
            <ul>
              <li>Clic = sélectionner; <b>Shift</b> = multi-sélection; <b>Clic droit</b> sur une canalisation = jonction rapide.</li>
            </ul>
          </li>
          <li><b>Éditer (E)</b> :
            <ul>
              <li>Clic sur une canalisation pour afficher les <b>poignées</b> (sommets).</li>
              <li><b>Glisser</b> un sommet pour le déplacer; <b>Alt+clic</b> ou <b>clic droit</b> sur le segment pour insérer un sommet; <b>Suppr</b> pour supprimer.</li>
            </ul>
          </li>
          <li><b>Insérer (I)</b> :
            <ul>
              <li>Clic sur une <b>canalisation</b> pour insérer un nœud (jonction par défaut) et <b>découper</b> l’arête.</li>
              <li>Un <b>mini‑menu</b> propose le type (Jonction/PM/Vanne) et « <b>Démarrer une antenne</b> » pour enchaîner en Dessiner.</li>
            </ul>
          </li>
          <li><b>OUVRAGE/PM/Vanne</b> : la <b>position</b> est gérée dans la fiche <b>Canalisation</b> (séquence). Depuis leur fiche, tu peux changer la <b>canalisation</b>.</li>
          <li><b>Raccourcis</b> : V (Sélection), D (Dessiner), E (Éditer), I (Insérer), L (Agencer), Échap (sélection), Ctrl/Cmd+Z (Annuler), Ctrl/Cmd+Y (Rétablir), Ctrl/Cmd+C / Ctrl/Cmd+V (Copier/Coller).</li>
        </ul>
        <footer><button id="helpCloseBtn" class="btn">Fermer</button></footer>
      </article>
    </dialog>

    <div id="status"></div>
    <div id="ctx"></div>

    <script defer src="/static/bundle/vendor.js"></script>
    <script defer src="/static/bundle/polyfills.js"></script>
    <script defer src="/static/bundle/editor.js"></script>
  </body>
  </html>
