:root{
  --bg:#162138; --panel:#1f2b46; --muted:#a9bddb; --text:#f2f7ff;
  --node:#1a2b4a; --stroke:#2e4674; --grid: rgba(255,255,255,.06);
  --edge-color:#eaf2ff; --edge-color-sel:#d5e6ff; --accent:#6aa8ff;
  --chip:#283a60; --badge-bg:#0f2747; --badge-stroke:#345d9b;
  --shadow:0 8px 24px rgba(0,0,0,.25);
  --btn-bg:#21355b; --btn-bd:#304a7a; --btn-fg:#f2f7ff;
  --btn-bg-hover:#28426f; --btn-bd-hover:#3f66a5;
  --btn-ghost-bg:transparent; --btn-ghost-fg:#f2f7ff;
  --c-puits:#18608c; /* ouvrages */
  --c-cana:#1b3d46; /* canalisations */
  --c-plat:#5c3a1d; /* général */
  --c-vanne:#2c2b40;
  --c-pm:#20385c;
  --edge-hit: 28px; --log-border:#2b3f69; --prop-width:420px;
}
body[data-theme="light"]{
  --bg:#f6f8fc; --panel:#ffffff; --muted:#374151; --text:#1d2433;
  --node:#eef3fb; --stroke:#b8c9e6; --grid:rgba(0,0,0,.06);
  --edge-color:#3a5ea8; --edge-color-sel:#1945a8; --accent:#245ef5;
  --chip:#eaf1ff; --badge-bg:#eaf1ff; --badge-stroke:#b7cffc;
  --btn-bg:#eaf1ff; --btn-bd:#c7d7f7; --btn-fg:#1d2433;
  --btn-bg-hover:#dce9ff; --btn-bd-hover:#bcd0f2; --btn-ghost-bg:transparent; --btn-ghost-fg:#1d2433;
  --c-puits:#ffffff; --c-cana:#f4fbff; --c-plat:#fff0d6; --c-vanne:#f5f2ff; --c-pm:#f2f7ff; --log-border:#e5ecfb;
}
/* Light theme readability adjustments */
body[data-theme="light"] .card{ color: var(--text) }
body[data-theme="light"] label{ color: var(--muted) }
body[data-theme="light"] #noSel{ color: var(--muted) }
body[data-theme="light"] .menu{ color: var(--text); background:#fff; border-color:#dbe4f6 }
body[data-theme="light"] .menu .item:hover{ background:#eef3ff }
/* Improve label readability in light mode */
body[data-theme="light"] label{ color: var(--muted) }
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
header.appbar{position:relative; z-index:2; min-height:56px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; padding:8px 12px; background:linear-gradient(180deg, rgba(26,39,68,.9), rgba(23,36,61,.9)); border-bottom:1px solid #2b3f69; box-shadow:var(--shadow)}
body[data-theme="light"] header.appbar{background:linear-gradient(180deg, #fff, #f2f6ff); border-bottom-color:#e5ecfb}
.title{font-weight:600; letter-spacing:.2px; margin-right:8px; color:var(--text)}
.spacer{flex:1}
.btn{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--btn-bd); background:var(--btn-bg); color:var(--btn-fg); cursor:pointer; user-select:none}
.btn:hover{border-color:var(--btn-bd-hover); background:var(--btn-bg-hover)}
.btn.primary{background:linear-gradient(180deg,#3f7bff,#2b5fe0); border-color:#3c74ff; color:#fff}
.btn.ghost{background:var(--btn-ghost-bg); color:var(--btn-ghost-fg); border-color:transparent}
.btn.active{box-shadow:inset 0 0 0 2px var(--accent)}
.seg{display:inline-flex;border:1px solid var(--btn-bd);border-radius:10px;overflow:hidden}
.seg button{background:var(--btn-bg);border:0;padding:8px 12px;color:var(--btn-fg);cursor:pointer}
.seg button.active, .seg button:hover{background:var(--btn-bg-hover)}
body[data-theme="light"] .seg{border-color:var(--btn-bd)}
#wrap{position:absolute; left:0; right:0; bottom:0; top: var(--appbar-height, 70px); display:grid; grid-template-columns:1fr var(--prop-width)}
body.prop-collapsed #wrap{ grid-template-columns:1fr 0 }
#canvas{position:relative; overflow:hidden; background: linear-gradient(0deg, transparent 24%, var(--grid) 25%, var(--grid) 26%, transparent 27%, transparent 74%, var(--grid) 75%, var(--grid) 76%, transparent 77%), linear-gradient(90deg, transparent 24%, var(--grid) 25%, var(--grid) 26%, transparent 27%, transparent 74%, var(--grid) 75%, var(--grid) 76%, transparent 77%); background-size:32px 32px,32px 32px}
#map{ position:absolute; inset:0; z-index:0; pointer-events:none }
body.map-hidden #map{ display:none }
body.graph-view #map{ display:none !important }
body.graph-view #canvas{ background: radial-gradient(circle at 20% 20%, rgba(106,168,255,0.08), transparent 55%), radial-gradient(circle at 80% 30%, rgba(148,187,233,0.08), transparent 60%), linear-gradient(0deg, transparent 24%, var(--grid) 25%, var(--grid) 26%, transparent 27%, transparent 74%, var(--grid) 75%, var(--grid) 76%, transparent 77%), linear-gradient(90deg, transparent 24%, var(--grid) 25%, var(--grid) 26%, transparent 27%, transparent 74%, var(--grid) 75%, var(--grid) 76%, transparent 77%); background-size:32px 32px,32px 32px,32px 32px,32px 32px }
svg{ position:absolute; inset:0; z-index:1; width:100%; height:100% }
.node rect.box{rx:14; ry:14; stroke:var(--stroke); fill:var(--node); fill-opacity:.82; filter: drop-shadow(0 2px 16px rgba(0,0,0,.22))}
.node.selected rect.box{stroke:var(--accent); stroke-width:2}
.node.halo rect.box{ stroke: var(--accent); stroke-width: 2; filter: drop-shadow(0 0 8px rgba(106,168,255,.35)) }
.node.PUITS rect.box{fill:var(--c-puits)}
.node.OUVRAGE rect.box{fill:var(--c-puits)}
.node.CANALISATION rect.box{fill:var(--c-cana)}
.node.PLATEFORME rect.box{fill:var(--c-plat)}
.node.GENERAL rect.box{fill:var(--c-plat)}
.node.VANNE rect.box{fill:var(--c-vanne)}
.node.POINT_MESURE rect.box{fill:var(--c-pm)}
.node rect.hit{fill:transparent; stroke:none; pointer-events:all}
.node.JONCTION circle.junction-dot{ fill: var(--edge-color); stroke: #fff; stroke-width: 1.5px; pointer-events:none }
.node text.badge{font-size:11px; font-weight:600; letter-spacing:.4px; text-transform:uppercase; fill:#fcd34d}
.node text.badge.missing-site{fill:#f87171}
.label{font:13px/1.2 Inter,sans-serif; fill:var(--text); pointer-events:none}
.sublabel{font:11px/1.1 Inter,sans-serif; fill:var(--muted); pointer-events:none}
.edge path.line{fill:none; stroke-linecap:round}
.edge path.hit{stroke:rgba(0,0,0,0); stroke-width:var(--edge-hit); fill:none; pointer-events:stroke}
#arrow path, #arrowSel path{ fill: context-stroke; stroke: context-stroke; }
.pm-connector,
.valve-connector {
  stroke-dasharray: none;
  stroke-width: 1.6;
  fill: none;
  pointer-events: none;
}
aside#prop{background:var(--panel); border-left:1px solid #2b3f69; padding:14px 14px 80px; overflow:auto}
body.prop-collapsed aside#prop{padding:0; border-left:none; visibility:hidden; pointer-events:none}
.card{background:#1b2b4b; border:1px solid #2f4b7d; border-radius:14px; padding:12px; box-shadow:var(--shadow)}
body[data-theme="light"] .card{background:#fff; border-color:#e5ecfb}
label{font-size:12px; color:var(--muted); display:block; margin:10px 0 4px}
input,select{width:100%; background:#182a4a; border:1px solid #37578f; color:#fff; padding:10px 12px; border-radius:10px}
input[readonly]{opacity:.85}
body[data-theme="light"] input, body[data-theme="light"] select{background:#f7faff; color:#1d2433; border-color:#bcd0f2}
details summary{cursor:pointer}
/* Details grouping styles */
#prop #nodeForm details{ margin:10px 0 }
#prop #nodeForm details > summary{ font-weight:600; color:var(--text) }
#prop #nodeForm details details{ margin-left:12px; padding-left:10px; border-left:1px dashed var(--stroke) }
#prop #nodeForm details details > summary{ font-weight:500 }
.danger{color:#ff9a9a}
.chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; min-width:0}
.chip{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; background:var(--chip); border:1px solid #3b5d98; border-radius:10px}
.chip.ghost{ background:transparent; border-style:dashed; opacity:.9 }
.chip.ghost:hover{ background:var(--btn-bg-hover); border-color:var(--btn-bd-hover); opacity:1 }
.chip .drag{cursor:grab}
.chip.dragging{opacity:.7}
.badges{display:flex; gap:6px; margin-top:6px}
.badge{font-size:10px; padding:3px 6px; background:var(--badge-bg); color:var(--text); border:1px solid var(--badge-stroke); border-radius:8px}
.marquee{ fill:rgba(166,200,255,.15); stroke:#a6c8ff; stroke-dasharray:4 3; pointer-events:none }
#logDrawer{ position:absolute; left:0; right:var(--prop-width); bottom:0; height:190px; background:var(--panel); border-top:1px solid var(--log-border); display:none; grid-template-rows:auto 1fr; z-index:5; }
#logDrawer.open{display:grid;}
#logHeader{display:flex; align-items:center; gap:8px; padding:6px 10px; border-bottom:1px solid var(--log-border)}
#logBody{overflow:auto; font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; padding:8px 10px; white-space:pre-wrap}
.log-line{margin:0}
.log-info{color:#b9d4ff}
.log-warn{color:#ffd88a}
.log-error{color:#ffb0b0}
/* Light theme: stronger log colors */
body[data-theme="light"] #logDrawer{ background:#fff }
body[data-theme="light"] .log-info{ color:#1f2937 }
body[data-theme="light"] .log-warn{ color:#92400e }
body[data-theme="light"] .log-error{ color:#b91c1c }
/* Étendre le journal sur toute la largeur si panneau propriétés replié */
body.prop-collapsed #logDrawer{ right:0; }
#status{position:absolute; left:12px; bottom:12px; background:#1b2b4b; color:#dfe9ff; padding:8px 12px; border-radius:10px; border:1px solid #2f4b7d}
body[data-theme="light"] #status{background:#fff; color:#1d2433; border-color:#e5ecfb}
.menu-add{position:relative}
.menu{display:none; position:fixed; min-width:240px; background:#1b2b4b; border:1px solid #2f4b7d; border-radius:12px; box-shadow:var(--shadow); z-index:10000}
.menu.open{display:block}
.menu .item{display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer}
.menu .item:hover{background:#223a67}
body[data-theme="light"] .menu{background:#fff; border-color:#e5ecfb}
.hidden{display:none !important}

/* HUD overlay */
#hud{
  position: fixed;
  top: 8px; right: 12px;
  background: rgba(17,24,39,.85);
  color: #e5e7eb;
  border: 1px solid #334155;
  border-radius: 8px;
  padding: 6px 10px;
  font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  z-index: 10;
  pointer-events: none;
}
body[data-theme="light"] #hud{ background:#fff; color:#111827; border-color:#cbd5e1 }

/* Mode contextual help */
#modeHelp{
  position: fixed; 
  right: 12px; 
  top: calc(var(--appbar-height, 70px) + 8px);
  max-width: 380px;
  background: rgba(17,24,39,.92);
  color: #e5e7eb;
  border: 1px solid #334155;
  border-radius: 10px;
  box-shadow: var(--shadow);
  padding: 10px 12px 10px 12px;
  z-index: 20;
  display: none;
}
#modeHelp.open{ display:block }
#modeHelp .close{ position:absolute; right:6px; top:4px; background:transparent; border:0; color:#9ca3af; font-size:16px; cursor:pointer }
#modeHelp .content{ font: 12px/1.35 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
#modeHelp ul{ margin:6px 0 0 16px; padding:0 }
#modeHelp li{ margin:2px 0 }
body[data-theme="light"] #modeHelp{ background:#fff; color:#111827; border-color:#cbd5e1 }
